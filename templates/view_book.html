{% extends "base.html" %}
{% block content %}
    <!-- Selected Book -->
    <div class="row">
        <div class="col s12">
            <h3 class="center subtitle">{{ this_book.title }}</h3>
        </div>
    </div>
        <div class="row">
            <div class="col s12 m6 center">
                <img src="{{ this_book.thumbnail }}" class="cover"><br>
            </div>
            <div class="col s12 m6 left-align">
                <p>Author: {{ this_book.authors[0] }}</p>
                <p>Category: {{ this_book.category }}</p>
                <p>Description: {{ this_book.description }}</p> 
            </div>
        </div>
        <div class="row">
            <div class="col s6 m3 center">
                <a href="{{ book_purchase_url }}" rel="nofollow" target="_blank" title="Buy it now" class="button">
                    <span class="btn blue">Buy it now</span> 
                </a>
            </div>
            <div class="col s6 m3">
            {% if this_book_reviews %}
                <!-- If there are book reviews and this user has not already written one for this book display the Write a Review button -->
                {% if session.user not in reviewers %}
                    <a href="{{ url_for('add_review', book_id=this_book._id) }}" rel="nofollow" title="Buy it now" class="button">
                        <span class="btn orange">Write a Review</span> 
                    </a>
                {% endif %}
            {% else %}
                    <!-- If there are currently no reviews for this book display the Write a Review button -->
                    <a href="{{ url_for('add_review', book_id=this_book._id) }}" rel="nofollow" title="Buy it now" class="button">
                        <span class="btn orange">Write a Review</span> 
                    </a>
            {% endif %}
            </div>
            <div class="col s12 m6 left-align">
                <p>Page Count: {{ this_book.page_count }}</p> 
                <p>Date Published: {{ this_book.published_date }}</p> 
                <p>Publisher: {{ this_book.publisher }}</p> 
                <p>ISBN 13: {{ this_book.isbn }}</p> 
            </div>
        </div>
        <!-- Message to display if no reviews exist -->
        {% if not this_book_reviews %}
            <div class="row">
                <div class="col s12 m6 offset-m6">
                    <p>No reviews currently exist for this book.</p>
                </div>
            </div>
        {% else %}
            {% for review in this_book_reviews %}
                <div class="row">
                    <div class="col s4 m3 offset-m1">
                        <p>Reviewed By: {{ review.created_by }}</p>
                        <p>On: {{ review.review_date }}</p>
                            <!-- Check to see whether there is a user logged in -->
                            {% if session.user %}
                                <!-- Check to see whether the user wrote the review, if so, display the Edit button -->
                                {% if session.user == review.created_by %}
                                    <p>                                        
                                        <a href="{{ url_for('edit_review', book_id=this_book._id, review_id=review._id) }}" class="btn grey"><i class="fas fa-user-edit"></i> Edit</a>
                                    </p>
                                {% else %}
                                    <!-- Check to see whether the logged in user upvoted the review already, if not, display the Upvote button -->
                                    {% if session.user in review.upvoters %}
                                    {% else %}
                                        <p>
                                            <form action="{{ url_for('upvote_review', review_id=review._id ) }}" method="post">
                                                <button type="submit" name="upvote" value="1" class="btn grey">{{ review.review_score }} <i class="fas fa-caret-up prefix"></i> Upvote</button>
                                            </form>
                                        </p>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                    </div>
                    <div class="col s8 star-rating">
                        <p>Star Rating: 
                            {% set starRating = review.rating | int %}
                            {% for i in range(starRating) %}
                                <i class="fas fa-star"></i>
                            {% endfor %} 
                        </p>
                        <p>Review: {{ review.review }}</p>
                    </div>
                </div>
            {% endfor %}        
        {% endif %}



{% endblock %}